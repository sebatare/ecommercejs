name: Deploy Ecommerce to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout del cÃ³digo
      - name: Checkout code
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Despliegue vÃ­a SSH
      - name: Deploy with SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "ðŸ”¹ Marcando repo seguro para Git..."
            git config --global --add safe.directory /home/deployuser/ecommercejs

            echo "ðŸ”¹ Verificando Node y NPM global..."
            node -v
            npm -v

            # 3ï¸âƒ£ Actualizar cÃ³digo
            echo "ðŸ”¹ Actualizando cÃ³digo desde Git..."
            cd /home/deployuser/ecommercejs
            git fetch --all
            git reset --hard origin/main
            git pull

            # 4ï¸âƒ£ Backend: instalar dependencias
            echo "ðŸ”¹ Instalando dependencias del backend..."
            cd backend
            npm install

            # 5ï¸âƒ£ Frontend: instalar dependencias y build
            echo "ðŸ”¹ Instalando dependencias del frontend..."
            cd ../frontend
            npm install
            echo "ðŸ”¹ Construyendo frontend..."
            npm run build

            # 6ï¸âƒ£ Reiniciar Nginx
            echo "ðŸ”¹ Reiniciando Nginx..."
            sudo nginx -t
            sudo systemctl restart nginx

            # 7ï¸âƒ£ Reiniciar backend con PM2
            echo "ðŸ”¹ Reiniciando backend con PM2..."
            cd ../backend
            pm2 describe ecommerce-backend >/dev/null 2>&1 && \
            pm2 reload ecommerce-backend --update-env || \
            pm2 start server.js --name ecommerce-backend
            pm2 save

            echo "âœ… Despliegue completado."
