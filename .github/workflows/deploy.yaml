name: Deploy to Raspberry Pi

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy with SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST_RPI }}       # ðŸ‘‰ Define este secreto en GitHub con la IP (192.168.100.51)
          username: ${{ secrets.SSH_USER_RPI }}   # ðŸ‘‰ Define este secreto en GitHub (ej. "sebastian")
          key: ${{ secrets.SSH_PRIVATE_KEY_RPI }} # ðŸ‘‰ Define este secreto en GitHub (tu clave privada .pem o id_rsa)
          script: |
            echo "Entrando al backend..."
            cd /home/sebastian/ecommercejs/backend/src

            echo "Actualizando repo..."
            git pull

            echo "Instalando dependencias..."
            npm ci

            echo "Compilando..."
            npm run build || true

            echo "Reiniciando servicio..."
            pm2 restart ecommerce-backend || pm2 start main.js --name ecommerce-backend

            echo "âœ… Deploy completado en Raspberry Pi."
