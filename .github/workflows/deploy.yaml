name: Deploy Ecommerce
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            #!/bin/bash -l

            # Asegurar que NVM estÃ© cargado
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            echo "ðŸ”¹ Verificando entorno..."
            echo "Node: $(node -v) - $(which node)"
            echo "NPM: $(npm -v) - $(which npm)"
            echo "PM2: $(pm2 -v) - $(which pm2)"

            echo "ðŸ”¹ Marcando repo seguro para Git..."
            git config --global --add safe.directory /home/deployuser/ecommercejs

            cd /home/deployuser/ecommercejs

            # Guardar hash previo
            PREV_HASH=$(git rev-parse HEAD 2>/dev/null || echo "")

            echo "ðŸ”¹ Actualizando repo..."
            git fetch --all
            git reset --hard origin/main
            git pull origin main

            # Guardar hash nuevo
            NEW_HASH=$(git rev-parse HEAD)

            # Si no hay hash previo (primer deploy), forzar instalaciÃ³n
            if [ -z "$PREV_HASH" ]; then
              echo "ðŸ”¹ Primer despliegue detectado, instalando todo..."
              cd backend
              npm install
              pm2 describe ecommerce-backend >/dev/null 2>&1 && \
                pm2 reload ecommerce-backend --update-env || \
                pm2 start server.js --name ecommerce-backend
              cd ../frontend
              npm install
              npm run build
              cd ..
            else
              # Backend: instalar deps solo si cambiÃ³ package.json
              if git diff --name-only $PREV_HASH $NEW_HASH | grep -qE '^backend/package\.json|^backend/package-lock\.json'; then
                echo "ðŸ”¹ Cambios en backend/package.json detectados, instalando deps..."
                cd backend
                npm install
                cd ..
              else
                echo "ðŸ”¹ No hay cambios en backend/package.json, saltando npm install."
              fi
              
              # Backend: recargar PM2 solo si hay cambios en backend
              if git diff --name-only $PREV_HASH $NEW_HASH | grep -qE '^backend/'; then
                echo "ðŸ”¹ Cambios en backend detectados, recargando PM2..."
                cd backend
                pm2 describe ecommerce-backend >/dev/null 2>&1 && \
                  pm2 reload ecommerce-backend --update-env || \
                  pm2 start server.js --name ecommerce-backend
                cd ..
              else
                echo "ðŸ”¹ No hay cambios en backend, PM2 no se recarga."
              fi
              
              # Frontend: instalar deps si package.json cambiÃ³
              if git diff --name-only $PREV_HASH $NEW_HASH | grep -qE '^frontend/package\.json|^frontend/package-lock\.json'; then
                echo "ðŸ”¹ Cambios en frontend/package.json detectados, instalando deps..."
                cd frontend
                npm install
                cd ..
              else
                echo "ðŸ”¹ No hay cambios en frontend/package.json, saltando npm install."
              fi
              
              # Frontend: build si hay cambios
              if git diff --name-only $PREV_HASH $NEW_HASH | grep -qE '^frontend/'; then
                echo "ðŸ”¹ Cambios en frontend detectados, construyendo..."
                cd frontend
                npm run build
                cd ..
              else
                echo "ðŸ”¹ No hay cambios en frontend, saltando build."
              fi
            fi

            # Reiniciar Nginx siempre
            echo "ðŸ”¹ Reiniciando Nginx..."
            sudo nginx -t
            sudo systemctl restart nginx

            # Guardar estado de PM2
            pm2 save

            echo "âœ… Despliegue completado."
