name: Deploy Ecommerce to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy with SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "ðŸ”¹ Marcando repo seguro para Git..."
            git config --global --add safe.directory /home/deployuser/ecommercejs

            echo "ðŸ”¹ Cargando NVM y Node..."
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 20.18.1 || { echo "Node no disponible"; exit 1; }

            # AÃ±adir Node y PM2 al PATH explÃ­citamente
            export PATH="$NVM_DIR/versions/node/v20.18.1/bin:$PATH"

            echo "Node: $(node -v)"
            echo "NPM: $(npm -v)"
            echo "PM2: $(pm2 -v || echo 'PM2 no estÃ¡ instalado')"

            echo "ðŸ”¹ Ajustando permisos del repo..."
            sudo chown -R deployuser:deployuser /home/deployuser/ecommercejs
            cd /home/deployuser/ecommercejs

            # Guardar hash previo
            PREV_HASH=$(git rev-parse HEAD)

            echo "ðŸ”¹ Actualizando repo..."
            git fetch --all
            git reset --hard origin/main
            git pull

            # Guardar hash nuevo
            NEW_HASH=$(git rev-parse HEAD)

            # Backend: instalar deps si package.json cambiÃ³
            if git diff --name-only $PREV_HASH $NEW_HASH | grep -qE '^backend/package\.json|^backend/package-lock\.json'; then
              echo "ðŸ”¹ Cambios en backend/package.json detectados, instalando deps..."
              cd backend
              npm install
              cd ..
            else
              echo "ðŸ”¹ No hay cambios en backend/package.json, saltando npm install."
            fi

            # Backend: recargar PM2 si hay cambios en src
            if git diff --name-only $PREV_HASH $NEW_HASH | grep -qE '^backend/src/'; then
              echo "ðŸ”¹ Cambios en backend/src detectados, recargando PM2..."
              cd backend
              pm2 describe ecommerce-backend >/dev/null 2>&1 && \
                pm2 reload ecommerce-backend --update-env || \
                pm2 start server.js --name ecommerce-backend
              cd ..
            else
              echo "ðŸ”¹ No hay cambios en backend/src, PM2 no se recarga."
            fi

            # Frontend: instalar deps si package.json cambiÃ³
            if git diff --name-only $PREV_HASH $NEW_HASH | grep -qE '^frontend/package\.json|^frontend/package-lock\.json'; then
              echo "ðŸ”¹ Cambios en frontend/package.json detectados, instalando deps..."
              cd frontend
              npm install
              cd ..
            else
              echo "ðŸ”¹ No hay cambios en frontend/package.json, saltando npm install."
            fi

            # Frontend: build si src cambiÃ³
            if git diff --name-only $PREV_HASH $NEW_HASH | grep -qE '^frontend/src/'; then
              echo "ðŸ”¹ Cambios en frontend/src detectados, construyendo frontend..."
              cd frontend
              npm run build
              cd ..
            else
              echo "ðŸ”¹ No hay cambios en frontend/src, saltando build."
            fi

            # Reiniciar Nginx siempre
            echo "ðŸ”¹ Reiniciando Nginx..."
            sudo nginx -t
            sudo systemctl restart nginx

            # Guardar estado de PM2
            pm2 save

            echo "âœ… Despliegue completado."

          sync: false
          use_insecure_cipher: false
          timeout: 30s
          command_timeout: 10m
          proxy_port: 22
          proxy_timeout: 30s
          proxy_use_insecure_cipher: false
          script_stop: false
          debug: false
