name: Deploy Ecommerce to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy with SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "ğŸ”¹ Marcando repo seguro para Git..."
            git config --global --add safe.directory /home/deployuser/ecommercejs

            echo "ğŸ”¹ Verificando Node, NPM y PM2 globales..."
            node -v
            npm -v
            pm2 -v || echo "PM2 no estÃ¡ instalado"

            echo "ğŸ”¹ Ajustando permisos del repo..."
            sudo chown -R deployuser:deployuser /home/deployuser/ecommercejs

            cd /home/deployuser/ecommercejs

            # Guardar hash anterior
            PREV_HASH=$(git rev-parse HEAD)

            # Actualizar repo
            echo "ğŸ”¹ Actualizando cÃ³digo desde Git..."
            git fetch --all
            git reset --hard origin/main
            git pull

            # Guardar nuevo hash
            NEW_HASH=$(git rev-parse HEAD)

            # 1ï¸âƒ£ Backend: instalar deps solo si cambiÃ³ package.json
            if git diff --name-only $PREV_HASH $NEW_HASH | grep -qE '^backend/package\.json|^backend/package-lock\.json'; then
              echo "ğŸ”¹ Cambios en backend/package.json detectados, instalando dependencias..."
              cd backend
              npm install
              cd ..
            else
              echo "ğŸ”¹ No hay cambios en backend/package.json, saltando npm install."
            fi

            # 2ï¸âƒ£ Backend: recargar PM2 solo si hay cambios en backend/src
            if git diff --name-only $PREV_HASH $NEW_HASH | grep -qE '^backend/src/'; then
              echo "ğŸ”¹ Cambios en backend/src detectados, recargando PM2..."
              cd backend
              pm2 describe ecommerce-backend >/dev/null 2>&1 && \
                pm2 reload ecommerce-backend --update-env || \
                pm2 start server.js --name ecommerce-backend
              cd ..
            else
              echo "ğŸ”¹ No hay cambios en backend/src, PM2 no se recarga."
            fi

            # 3ï¸âƒ£ Frontend: instalar deps si package.json cambiÃ³
            if git diff --name-only $PREV_HASH $NEW_HASH | grep -qE '^frontend/package\.json|^frontend/package-lock\.json'; then
              echo "ğŸ”¹ Cambios en frontend/package.json detectados, instalando dependencias..."
              cd frontend
              npm install
              cd ..
            else
              echo "ğŸ”¹ No hay cambios en frontend/package.json, saltando npm install."
            fi

            # 4ï¸âƒ£ Frontend: build solo si src cambiÃ³
            if git diff --name-only $PREV_HASH $NEW_HASH | grep -qE '^frontend/src/'; then
              echo "ğŸ”¹ Cambios en frontend/src detectados, construyendo frontend..."
              cd frontend
              npm run build
              cd ..
            else
              echo "ğŸ”¹ No hay cambios en frontend/src, saltando build."
            fi

            # 5ï¸âƒ£ Reiniciar Nginx siempre
            echo "ğŸ”¹ Reiniciando Nginx..."
            sudo nginx -t
            sudo systemctl restart nginx

            # 6ï¸âƒ£ Guardar PM2
            pm2 save

            echo "âœ… Despliegue completado."
