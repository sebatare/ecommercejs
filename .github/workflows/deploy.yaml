name: Deploy Ecommerce

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "ðŸ”¹ Marcando repo seguro para Git..."
            git config --global --add safe.directory /home/deployuser/ecommercejs

            echo "ðŸ”¹ Verificando Node, NPM y PM2 globales..."
            echo "Node: $(node -v)"
            echo "NPM: $(npm -v)"

            # Instala PM2 global si no existe
            if ! command -v pm2 &>/dev/null; then
              echo "ðŸ”¹ PM2 no estÃ¡ instalado, instalando..."
              sudo npm install -g pm2
            fi
            echo "PM2: $(pm2 -v)"

            echo "ðŸ”¹ Ajustando permisos del repo..."
            sudo chown -R deployuser:deployuser /home/deployuser/ecommercejs
            cd /home/deployuser/ecommercejs

            # Guardar hash previo
            PREV_HASH=$(git rev-parse HEAD)

            echo "ðŸ”¹ Actualizando repo..."
            git fetch --all
            git reset --hard origin/main
            git pull

            # Guardar hash nuevo
            NEW_HASH=$(git rev-parse HEAD)

            # Backend: instalar deps solo si cambiÃ³ package.json
            if git diff --name-only $PREV_HASH $NEW_HASH | grep -qE '^backend/package\.json|^backend/package-lock\.json'; then
              echo "ðŸ”¹ Cambios en backend/package.json detectados, instalando deps..."
              cd backend
              npm install
              cd ..
            else
              echo "ðŸ”¹ No hay cambios en backend/package.json, saltando npm install."
            fi

            # Backend: recargar PM2 solo si hay cambios en src
            if git diff --name-only $PREV_HASH $NEW_HASH | grep -qE '^backend/src/'; then
              echo "ðŸ”¹ Cambios en backend/src detectados, recargando PM2..."
              cd backend
              pm2 describe ecommerce-backend >/dev/null 2>&1 && \
                pm2 reload ecommerce-backend --update-env || \
                pm2 start server.js --name ecommerce-backend
              cd ..
            else
              echo "ðŸ”¹ No hay cambios en backend/src, PM2 no se recarga."
            fi

            # Frontend: instalar deps si package.json cambiÃ³
            if git diff --name-only $PREV_HASH $NEW_HASH | grep -qE '^frontend/package\.json|^frontend/package-lock\.json'; then
              echo "ðŸ”¹ Cambios en frontend/package.json detectados, instalando deps..."
              cd frontend
              npm install
              cd ..
            else
              echo "ðŸ”¹ No hay cambios en frontend/package.json, saltando npm install."
            fi

            # Frontend: build si src cambiÃ³
            if git diff --name-only $PREV_HASH $NEW_HASH | grep -qE '^frontend/src/'; then
              echo "ðŸ”¹ Cambios en frontend/src detectados, construyendo frontend..."
              cd frontend
              npm run build
              cd ..
            else
              echo "ðŸ”¹ No hay cambios en frontend/src, saltando build."
            fi

            # Reiniciar Nginx siempre
            echo "ðŸ”¹ Reiniciando Nginx..."
            sudo nginx -t
            sudo systemctl restart nginx

            # Guardar estado de PM2
            pm2 save

            echo "âœ… Despliegue completado."
